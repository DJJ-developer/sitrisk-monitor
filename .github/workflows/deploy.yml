name: Deploy to GitHub Pages

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
    - name: ðŸ“‚ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸŒ Validate HTML Files
      run: |
        echo "ðŸ” Validating HTML files..."
        for file in *.html; do
          if [ -f "$file" ]; then
            echo "âœ… Found: $file"
          fi
        done
        
    - name: ðŸ“Š Validate JavaScript Files
      run: |
        echo "ðŸ” Validating JavaScript files..."
        for file in *.js; do
          if [ -f "$file" ]; then
            echo "âœ… Found: $file"
            # Basic syntax check
            node -c "$file" && echo "âœ… $file syntax OK"
          fi
        done
        
    - name: ðŸŽ¨ Validate CSS Files
      run: |
        echo "ðŸ” Validating CSS files..."
        for file in *.css; do
          if [ -f "$file" ]; then
            echo "âœ… Found: $file"
          fi
        done

    - name: ðŸš€ Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        exclude_assets: '.github'
        
    - name: ðŸ“ˆ Generate Deployment Report
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        echo "## ðŸš€ Deployment Report" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Site Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployment Time**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **HTML Files**: $(find . -name '*.html' | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- **JavaScript Files**: $(find . -name '*.js' | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- **CSS Files**: $(find . -name '*.css' | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŒ Access Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Live URL**: https://djj-developer.github.io/sitrisk-monitor/" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: âœ… Deployed Successfully" >> $GITHUB_STEP_SUMMARY
        
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“‚ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ”’ Basic Security Check
      run: |
        echo "## ðŸ”’ Security Check Report" >> security-report.md
        echo "### AdSense Policy Compliance" >> security-report.md
        
        # Check for fake ad content
        if grep -qi "fake.*ad\|premium.*ad.*banner\|fake.*revenue" *.html *.js; then
          echo "âŒ Potential fake ad content found" >> security-report.md
        else
          echo "âœ… No fake ad content detected" >> security-report.md
        fi
        
        # Check for proper AdSense containers
        if grep -q "google_ad_client\|data-ad-client" *.html *.js; then
          echo "âœ… AdSense containers found" >> security-report.md
        else
          echo "âš ï¸ No AdSense containers detected" >> security-report.md
        fi
        
        echo "### External Resources" >> security-report.md
        echo "CDN sources used:" >> security-report.md
        grep -o "https://[^'\"]*" *.html | grep -E "(cdn|googleapis|cloudflare)" >> security-report.md || echo "None found" >> security-report.md
        
        cat security-report.md
        
    - name: ðŸ“Š Upload Security Report
      uses: actions/upload-artifact@v4
      with:
        name: security-scan-report
        path: security-report.md 